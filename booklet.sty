% The 'random' human names in all the modules will be identical, unless we push
% the counters which determine the names.
\randomize
\addtocounter{humanNameNo}{-1}
\addtocounter{humanNameSuffNo}{\value{r12}}

\togglefalse{countedPage}
\togglefalse{intro}

\geometry{%
  paperwidth=74mm,
  paperheight=105mm,
  %showframe,
  footskip=3mm,
  foot=3mm,
  margin=5mm,
  bottom=5mm,
  includefoot,
}

\hfuzz=5.002pt 
\emergencystretch 2em
\setlength\columnsep{8pt}
\addtolength{\textfloatsep}{-1.6em}
%\addtolength{\floatsep}{-3em}
\addtolength{\intextsep}{-2pt}

\setcounter{segNoSpare}{1}

\setlength{\headwidth}{\textwidth}

\renewcommand{\labelenumi}{\arabic{enumi}. }

\renewcommand\bigLine{%
  \textcolor{background}{\ifodd\value{page}\else\raisebox{-3pt}{\normalsize\hspace{0.1em}\flourish}\fi\hrulefill\ifodd\value{page}\raisebox{-3pt}{\normalsize\hspace{-0.1em}\flourish}\fi}%
}

\let\olditemize\itemize%
\let\endolditemize\enditemize%
\renewenvironment{itemize}%
  {\begin{olditemize}%
     \setlength{\parskip}{0pt}}%
  {\end{olditemize}}

% Make quotes take less space.
\patchcmd{\quotation}{\rightmargin}{\leftmargin 1em \rightmargin}{}{}

\fancypagestyle{minizine}{
  \fontsize{9}{10}\selectfont
  \pagenumbering{arabic}
  \fancyhf{}% Clear Everything.
  \fancyfoot[RO]{\footnotesize\flourish\flourish\small\space\thepage}
  \fancyfoot[LE]{\small\thepage\space\footnotesize\flourish\flourish}
  \AddToHook{shipout/background}{%
    \ifodd\value{page}%
      \shiftColours[\value{segNoSpare}]%
      \color{background}%
      \stepcounter{segNoSpare}%
    \fi%
    \ifnum\value{page}=10%
      \begin{tikzpicture}[overlay, remember picture]%
        \draw[gray, dashed, thick] (current page.north west) -- (current page.south west);
      \end{tikzpicture}%
    \fi%
    \ifnum\value{page}=6%
      \begin{tikzpicture}[overlay, remember picture]%
        \draw[gray, dashed] (current page.north west) -- (current page.north east);
      \end{tikzpicture}%
    \fi%
    \ifnum\value{page}=14%
      \begin{tikzpicture}[overlay, remember picture]%
        \draw[gray, dashed, thick] (current page.north west) -- (current page.south west);
        \draw[gray, dashed] (current page.north west) -- (current page.north east);
        \draw[gray, dotted] (current page.north east) -- (current page.south east);
      \end{tikzpicture}%
    \fi%
  }%
} 

\fancypagestyle{miniCS}{
  \setlength{\tabcolsep}{0.1em}
  \pagenumbering{arabic}
  \setcounter{page}{1}
  \fontsize{9}{10}\selectfont
  \setlength{\headwidth}{\textwidth}
  \fancyhf{} % Clear Everything.
  \fancyfoot[LO]{\stateEquipment}
  \fancyfoot[LE]{\stateEquipment}
  \newgeometry{
    footskip=12mm,
    includefoot,
    margin=5mm,
  }%
  \AddToHook{shipout/background}{%
    \ifodd\value{page}%
      \shiftColours[\value{segNoSpare}]%
      \color{background}%
      \stepcounter{segNoSpare}%
    \fi%
    \ifnum\value{page}=7%
      \begin{tikzpicture}[overlay, remember picture]%
        \draw[black, dashed, thick] (current page.south west) -- (current page.south east);
      \end{tikzpicture}%
    \fi%
    \ifnum\value{page}=14%
      \begin{tikzpicture}[overlay, remember picture]%
        \draw[black, dashed, thick] (current page.north west) -- (current page.north east);
        \draw[black, dashed] (current page.north east) -- (current page.south east);
      \end{tikzpicture}%
    \fi%
  }%
} 

\newcommand*\frontCSNote[2]{%
  \large%
  \scshape%
  #1:
  &
  \iftoggle{examplecharacter}{ \pencilWriting{#2} }{ \lineDots }
}

\newcommand*\stateEquipment{%
  \ifcase\value{page}\relax%
  \or\relax%
  \or%
    \underline{Left:}
    \ifdefempty{\weaponName}{\lineDots}{%
      \pencilWriting{\expandafter\MakeUppercase\weaponName~(\absNum{weaponBonus}/ \absNum{weaponDamage}: \glsentrysymbol{weight} \arabic{weaponWeight})}
    }
  \or%
    \underline{Right:}
    \ifdefempty{\armourName}{\lineDots}{%
      \pencilWriting{\expandafter\MakeUppercase\armourName}
    }
  \or%
    \underline{Pack:}\quad%
    \ifdefempty{\equipi}{\lineDots}{%
      \pencilWriting{\equipi}
    }
  \or%
    \underline{\hspace{4em}}
    \ifdefempty{\equipii}{\lineDots}{%
      \pencilWriting{\equipii}
    }
  \or%
    \underline{\hspace{4em}}
    \ifdefempty{\equipiii}{\lineDots}{%
      \pencilWriting{\equipiii}
    }
  \or%
    \underline{\hspace{4em}}
    \ifdefempty{\equipiv}{\lineDots}{%
      \pencilWriting{\equipiv}
    }
  \else%
    \ifnum\thepage>\value{hp}%
      \glsentrysymbol{weight}~\underline{\hspace{5em}}
    \fi%
    \lineDots
  \fi%
}

\setcounter{bookLevel}{1}

\newcommand*\zineTitle[1]{%
  \noindent
  {\normalsize\scshape#1}%
  \par\vspace{1em}\noindent
}

\newcommand\showGls[1]{%
  \needspace{1em}
  \parindent10pt
  \noindent%
  {\scshape\bfseries\large\glsfmtname{#1}}
  \glsentrydesc{#1}.
  \par
  \vspace{.7em}%
  \ifnum\the\c@page=3%
    \pagestyle{minizine}%
  \fi%
}

\newcommand\raggedGls[1]{%
  \raggedright
  \noindent%
  {\scshape\bfseries\large\glsfmtname{#1}}
  \glsentrydesc{#1}%
}


\newcommand\miniCover[2]{
  \pagestyle{empty}
  \vspace{\baselineskip}
  \begin{tikzpicture}[overlay, remember picture]%
    \path 
      ++(current page.north east)
      +(-3mm, -3mm)
      node[
        font=\titleFont,
      ] {\glsentrysymbol{yonder}};
  \end{tikzpicture}%
  \hfill\includesvg[width=.3\textwidth]{config/logo}%
  {\huge~\Roman{bookLevel}}
  \begin{center}
    \par
    \vspace{2\baselineskip}
    {\Huge\scshape#1}
    #2
  \end{center}
  \clearpage
  \begin{tikzpicture}[overlay, remember picture]%
    \path 
      ++(current page.north west)
      +(3mm, -3mm)
      node[
        font=\titleFont,
      ] {\glsentrysymbol{yonder}};
  \end{tikzpicture}%
}

\newcommand\randomCYOAcharacter[2][\npc{\Hu}{\composeHumanName}]{
  \Person{#1}%
    {{rn1t2}{r3}{r0t1}}% BODY
    {{r3c}{rn1t2}{rn3t3}}% MIND
    {%
      \addtocounter{Dexterity}{-2}
      \addtocounter{Intelligence}{-2}
      \addtocounter{Wits}{-1}
      %%%%%%%%%%%%%%
      \ifodd\value{fenestraDay}
        \set{Projectiles}{1}
        \set{Larceny}{2}
        \ifodd\month
          \stepcounter{Melee}
        \else
          \set{Athletics}{2}
          \set{Caving}{1}
        \fi
      \else
        \set{Melee}{1}
        \set{Brawl}{1}
        \set{Vigilance}{1}
        \ifodd\month
          \set{Crafts}{2}
          \set{Survival}{1}
        \else
          \set{Stealth}{2}
          \set{Seafaring}{1}
        \fi
      \fi
      \ifodd\day
        \set{Deceit}{1}
      \else
        \set{Academics}{1}
      \fi
      \addtocounter{fp}{5}
    }% SKILLS
    {}% KNACKS
    {#2}% EQUIPMENT
    {}% ABILITIES
}

\newenvironment{selectPath}%
  {%
    \needspace{3\baselineskip}
    \begin{description}%
    \setlength\itemsep{.2em}
    \raggedright
  }%
  { \end{description} }

\newcommand\willYe[3]{%
  \item[#1]
  #2
  \ifstrequal{#3}{}{}{({\scshape\ifnum\value{list}<3 turn to \fi part~\vref{#3}})}
}

\newcommand\goTo[1]{
  ({Turn to part~\vref{#1}})
}

\newcommand\cyoaEnd[1][.]{
  {\scshape The End#1}
}

\renewcommand{\thread}[2][]{
  \stopcontents[segments]
  \foreach \area in {#1}%
    {\resumecontents[\area]}
  \renewcommand{\threadName}{#2}
  \needspace{2em}
  \subsection[\it #2]{\large#2}
  \setcounter{segNo}{0}
  \foreach \area in {#1}%
    {\stopcontents[\area]}
  \startcontents[segments]
}

\titleformat{\subsection}
  {\titleFont%
  \normalsize}%
  {\thesubsection}%
  {.2em}%
  {\center#1}%
  [\textcolor{background}{\titlerule}]

\titleformat{\subsubsection}[wrap]
{\filright%
\titleFont%
\normalsize\centering}
{}{.5em}{#1}

\titlespacing{\subsubsection}
{7pc}{1.5ex plus .1ex minus .2ex}{.5pc}

\titlecontents{fsubsubsection}
              [2em]
              {%
                \contentspush{%
                \ifnum\thesegNoSpare=1%
                  \sgr\else\sgn%
                \fi~%
                \ifnum\thesegNoSpare>0%
                  ~\thesegNoSpare%
                \else%
                  ~1%
                \fi:~%
                }%
                \thecontentslabel%
              }%
              {}%
              {}%
              { \titlerule*[1pc]{.}\bfseries\contentspage }%
              []%

\newcommand\bookletThreads[1]{
  \medskip
  \Needspace{3\baselineskip}
  \smash{\hspace{-2em}\underline{\scshape\ifglsentryexists{#1}{\Glsfmttext{#1}}{#1}}}
  \printThreadsInRegion{#1}
  \ifnum\the\c@page=3%
    \pagestyle{minizine}%
  \fi%
}


\renewcommand{\ent}[1]{\scriptsize\textbf{#1}}

\renewcommand\statblock[1]{
      \begin{figure*}[tb!]
      \begin{minipage}{\linewidth}
      \small
      #1%
      \colorlet{background}{white!25!black}%
      \begin{tabularx}{\linewidth}{@{}r@{\hskip.8em}L@{}}\hline%
      \rowcolors{2}{}{background!6}
      \ent{\normalsize\npcsymbol} & \ent{\name}%
      \ifdefempty{\NPCdescription}{~}{%
        --- \NPCdescription, \mannerism.  \textbf{Wants:}~\npcGoal.%
        \ifdefempty{\currentQuote}{}{\space\textbf{Quote:}~\textit{``\currentQuote''}}%
      }%
      \hfill\calculateXP \\\hline%
      \ent{\Glsfmtplural{attribute}} &
        \footnotesize
        {\scshape\footnotesize Str}~\arabic{Strength},
        {\scshape\footnotesize Dex}~\arabic{Dexterity},
        {\scshape\footnotesize Spd}~\arabic{Speed},
        \ifnum\value{Intelligence}>-6%
          {\scshape\footnotesize Int}~\arabic{Intelligence},
        \fi%
        {\scshape\footnotesize Wts}~\arabic{Wits}%
        \ifnum\value{Charisma}>-6%
          , {\scshape\footnotesize Cha}~\arabic{Charisma}
        \fi%
        %\foreach \s in {Strength,Dexterity,Speed,Intelligence,Wits,Charisma}%
        %  {\ifnum\value{\s}>-6\s~\arabic{\s}\quad\fi}
      \\
      \ent{Skills} & \showSkills
      \ifnum\value{mp}>0%
        \foreach \s in {Air,Earth,Fate,Fire,Water}%
          {\ifnum\value{\s}>0 \s~\arabic{\s}, \fi}
      \fi
      \\
      \ifdefempty{\Abilities}{
        \ifnum\value{knacks}>0
          \ent{Knacks} & \Knacks \\
        \fi
      }{%
        \ent{Abilities} & \Abilities%
        \ifnum\value{knacks}>0
          \Knacks
        \fi
        \\
      }
      \ifdefempty{\equipment}{}{%
        \ent{Equipment} &
        \ifdefempty{\weaponName}{}{%
          \weaponName, %
        }%
        \ifdefempty{\armourName}{}{%
          \armourName, %
        }%
        \equipment.
        \\
      }%
      \hline
      \end{tabularx}
      \ifnum\value{xp}>0
        \par\toggletrue{examplecharacter}% Stop CR showing
        \derivedstats%
        \ifnum\value{noAppearing}=1\hfill\else\par\fi%
        \showBoxes%
        \color{background}\hrulefill
      \fi
      \end{minipage}
      \end{figure*}
}

\renewcommand\swarm[6][]%
{
  \begin{figure*}[tb!]
  \begin{minipage}{\linewidth}
  \small
  \randomize
  \clean
  \renewcommand\name{#2}
  \set{hp}{#3}
  \set{Dexterity}{#4}
  \set{Strength}{-5}
  \set{toHit}{#4}
  \addtocounter{toHit}{10}
  \set{Speed}{#5}
  \set{ap}{#5}
  \addtocounter{ap}{3}
  \setcounter{dr}{8}
  \set{Wits}{#6}
  #1
  \set{freeHP}{hp}
  \setcounter{freeHP}{\value{hp}}%
  \addtocounter{freeHP}{-\value{weight}}%
  \scshape
  \begin{tabularx}{\textwidth}{rL}\hline
  \rowcolors{2}{}{background!6}
  \ent{\normalsize\glsentrysymbol{swarm}} & \ent{\name} 
    \hfil\textcolor{background}{\scriptsize\calculateXP} \\\hline
  \Gls{ap}: \arabic{ap} & Att: $\arabic{toHit} - HP$
  \iftoggle{intro}{
    \quad
    Speed: \arabic{Speed},
    \quad
    Wits: \arabic{Wits}
  }{
    Dam: 1
  }
  \\
  \ent{Abilities} & \Abilities \\
  \hline
  \end{tabularx}%
  \end{minipage}
  \par\hpStat
  \end{figure*}
}

\newwrite\spellbooks

\newcommand\writeSpheres{%
  \immediate\openout\spellbooks=Spells-\currentName.tex
  \setHighSpheres
  \foreach \s in {Light,Death,Life,Mind,Force,Earth,Air,Fire,Water,Fate}%
    {
      \immediate\write\spellbooks{\unexpanded{\setcounter}{\s}\arabic{\s}}
    }
}

%%%% Set individual equipment items.

\newcommand\equipi{}
\newcommand\equipii{}
\newcommand\equipiii{}
\newcommand\equipiv{}

\newcommand\splitEquipment{

  \renewcommand{\do}[1]{%
    \ifcase\thetrack
      \renewcommand\equipi{##1}%
    \or
      \renewcommand\equipii{##1}
    \or
      \renewcommand\equipiii{##1}
    \else%
      \renewcommand\equipiv{##1}
    \fi%
    \stepcounter{track}%
  }%
  \setcounter{track}{0}%
  \expandafter\docsvlist\expandafter{\equipment}
}


%%%%%
\renewcommand\filledCS[9]{
  {
    \resetCS
    \assignHumanName
    \settoggle{examplecharacter}{true}
    \settoggle{allyCharacter}{true}
    \renewcommand\name{#1}
    \renewcommand\race{#2}
    \renewcommand\concept{#3}
    \renewcommand\code{#4}
    \traits{}%
      {#5}%
      {#6}%
      {%
        #7
      }% SKILLS
      {#8}% KNACKS
      {#9}% EQUIPMENT
      {}% ABILITIES
    \setAgeAndAbilities

    \addtocounter{fp}{5}
    \ifnum\value{mp}>0
      \vphantom{\writeSpheres}
    \fi
    \colourWheel[r6]
    \input{config/booklets/cs.tex}
  }
}

\tcbset{breakable}

\pagenumbering{gobble}

