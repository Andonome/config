\fancypagestyle{market}{
  \togglefalse{countedPage}
  \renewcommand{\headrule}{}
  \fancyhf{}% clear all header and footer fields
  \fancyhead[RO]{\vspace{-2em}\scshape\showCycle}
  \AddToHook{shipout/background}{%
    \begin{tikzpicture}[overlay,remember picture]
      \coordinate (northgate) at (current page.north west);
      \coordinate (westgate) at (current page.south west);
      \coordinate (eastgate) at (current page.south east);
    \end{tikzpicture}
}

}

\tikzstyle{marketpath} = [background, very thick, dashed, very nearly transparent]

\newtoggle{marketBeasts}
\settoggle{marketBeasts}{false}

\newcommand\mkPrice[2][sp]{%
  \randomize%
  \setcounter{gold}{#2}%
  \ifnum\value{gold}<7%
    \ifnum\value{temperature}=0%
      \ifnum\value{gold}>0
        \addtocounter{gold}{3}
      \fi
    \fi%
  \else%
    \addtocounter{gold}{\value{rn3t3}}%
    \ifnum\value{gold}<14%
      \addtocounter{gold}{\value{r3b}}%
      \addtocounter{gold}{\value{rn1t2}}%
    \else%
      \addtocounter{gold}{\value{r6}}%
      \ifnum\value{gold}<34%
        \addtocounter{gold}{\value{r4t6}}%
      \else%
        \addtocounter{gold}{\value{r12}}%
      \fi%
    \fi%
  \fi%
  \ifnum0<\value{gold}%
    \arabic{gold}~\glspl{#1}%
  \else%
    \textit{free}!
  \fi%
}

\newcommand\marketItem[4][sp]{%
  \small%
  \ifnum#4>0%
    \randomize%
    $\ifcase#3\arabic{r3}\arabic{r6}\or\arabic{r12}\else\arabic{r6}\fi\times$~%
  \fi%
  #2
  &% Name
  #3 &% Weight
  \mkPrice[#1]{#4} % Price
  \\
}

\newcommand\marketService[3][sp]{%
  \ifnum#3>0%
    \randomize%
    $\ifnum#3>15 \arabic{r2b}\else\arabic{r6}\fi\times$
  \fi%
  #2
  &% Name
  \mkPrice[#1]{#3} % Price
  \\
}

\newcommand\rareMarketItem[4][7]{%
  \ifnumcomp{\value{r12}}{>}{#1}{%
    \small%
    $\ifnum#1<9 \arabic{r3c}\else 1\fi\times$
    #2 & #3 & \mkPrice{#4} \\%
  }{\randomize}%
  \randomize%
}

\newcommand\showArmourPrice[2]{%
  \small%
  $\ifnum#2<12 \arabic{r6}\else \arabic{r2c}\fi\times$
  #1\expandafter\MakeUppercase\armourName & \arabic{armourDR} & \arabic{covering} & \arabic{armourWeight} & \mkPrice{#2} \\%
}

\newcommand\rareArmour[3][9]{%
  \ifnumcomp{\value{r12}}{>}{#1}{%
    \small%
    $\ifnum#1<7 \arabic{r2}\else \arabic{r3c}\fi\times$~%
    \showArmour{#2} & \mkPrice{#3} \\%
  }{}%
  \randomize%
}

\newcommand\pinLocation[2][0,0]{%
  \tikz [overlay,remember picture] \coordinate (#2) at (#1);%
}

%%%%% Seller Names
% 
% By default, each guild hall curator receives a random name, composed
% with the standard '\composeHumanName' command.  However, individual
% modules might change these names to showcase local NPCs.

\newcommand\marketWeaver{\composeHumanName}
\newcommand\marketDoula{\composeHumanName}
\newcommand\marketBeastSeller{\composeHumanName}
\newcommand\marketBard{\composeHumanName}
\newcommand\marketInnTwo{\composeHumanName's Inn}
\newcommand\marketTavernOne{\composeHumanName's Tavern}
\newcommand\marketTavernTwo{\composeHumanName's Tavern}
\newcommand\marketMixer{\composeHumanName}
\newcommand\marketWeaponsSeller{\composeHumanName}
\newcommand\marketArmourSeller{\composeHumanName}
\newcommand\marketTanner{\composeHumanName}

\assignHumanName[\marketInnOne]
\assignHumanName[\marketBoatman]
\assignHumanName[\marketFence]
\assignHumanName[\fodderVagrant]

%%%%%% Adverts for the Pit of Justice %%%%%%

\newcommand\randomWeapon{%
  \ifcase\value{r6}\relax%
  \or%
    two flails%
  \or%
    a scythe%
  \or%
    a rusty spoon%
  \or%
    five shortswords%
  \or%
    a dagger and full plate armour%
  \else%
    just one rusted greatsword%
  \fi%
  \stepcounter{r4}
  \stepcounter{r6b}
}

\newcommand\fightAdvert{%
  \begin{tcolorbox}[ornamented,
  adjusted title={Spectacular},
  ]%
  \it%
  \center%
  Come see \underline{the \Glsfmttext{court}}\qquad%
  1\arabic{spellPlusTwo}~\glsfmtplural{cp}
  \sc
  \vspace{.8em}
  \randomize%
  \begin{tabularx}{\linewidth}{YcX}
  \hiderowcolors
  \raggedright
  \large
  \ifcase\value{r6}\relax%
  \or%
    \ifnum\value{temperature}>1%
      \Pgls{crawler}%
    \else%
      A bear%
    \fi%
  \or%
    A gaggle of \arabic{r4b}0~geese%
  \or%
    \arabic{r4t6}~blind men %
    \ifodd\value{r3c}%
      with glaives%
    \else%
      who think they have armour%
    \fi%
  \or%
    A lonely robber with \randomWeapon%
  \or%
    A clean shaven dwarf%
  \else%
    \arabic{r4t6}~\gls{guard} deserters with \randomWeapon%
  \fi%
  &
  \glsentrysymbol{paik} $\underbrace{\quad vs \quad}$ \glsentrysymbol{paik}
  &
  \large
  \raggedleft
  \ifcase\value{r12}\relax%
  \or%
    a gnomish illusionist (they never play fair!)%
  \or%
    \arabic{r2t4}~\glspl{griffin}%
  \or%
    \arabic{r4t6} \glspl{woodspy}%
  \or%
    1\arabic{r3t4}~blind men with \randomWeapon%
  \or%
    a lying \gls{seneschal}%
  \or%
    the `Undefeatable' \composeHumanName%
  \or%
    the last jester, wielding \randomWeapon%
  \or%
    \arabic{r6}~\gls{sunGuard} warriors%
  \or%
    \arabic{r2t4} disobedient youngsters%
  \or%
    `the Water-\gls{witch}'%
  \else%
    their own mother%
  \fi%
  \end{tabularx}%
  \par
  \vspace{-1em}
  \it%
  \ifcase\value{r6b}\relax%
  \or%
    \small Half price for %
    \ifodd\value{r2b}%
      couples%
    \else%
      the infirm%
    \fi%
  \or%
    \ldots chained together%
  \or%
    \ldots over hot coals%
  \or%
    \ldots all covered in oils%
  \or%
    One rock per spectator%
  \or%
    in a battle of boats%
  \else%
    \ldots with a surprise \gls{woodspy}%
  \fi%
  {\large\Repeat{\value{r4b}}{!}}%
  \end{tcolorbox}
}
